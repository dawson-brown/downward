#! /usr/bin/env python

import logging
import os
import multiprocessing
import subprocess
import sys

from lab.experiment import get_run_dir
from lab import tools

tools.configure_logging()

SHUFFLED_TASK_IDS = [518, 895, 38, 1010, 536, 1113, 456, 258, 1014, 410, 892, 581, 57, 952, 391, 626, 926, 694, 88, 944, 506, 816, 457, 143, 647, 436, 1040, 743, 361, 390, 593, 655, 63, 404, 890, 637, 1064, 679, 499, 320, 222, 401, 42, 341, 64, 333, 1117, 291, 327, 263, 197, 774, 448, 689, 1090, 925, 339, 997, 967, 1019, 923, 97, 122, 116, 267, 870, 447, 389, 239, 119, 618, 512, 749, 310, 775, 525, 671, 1052, 821, 1032, 21, 112, 1074, 247, 590, 622, 303, 934, 17, 552, 420, 44, 236, 1043, 256, 840, 24, 334, 400, 513, 881, 46, 215, 1002, 885, 124, 904, 929, 101, 185, 740, 528, 633, 899, 442, 516, 636, 975, 660, 508, 232, 66, 1053, 837, 548, 669, 1072, 76, 10, 969, 1070, 370, 858, 711, 139, 974, 789, 629, 502, 928, 454, 273, 754, 955, 367, 887, 667, 897, 132, 252, 299, 1024, 446, 918, 83, 243, 383, 860, 342, 81, 1093, 438, 235, 1115, 592, 149, 1034, 1005, 687, 1104, 329, 718, 466, 846, 417, 703, 192, 205, 347, 223, 693, 723, 412, 844, 843, 189, 705, 166, 764, 913, 722, 563, 479, 206, 283, 631, 600, 237, 615, 1094, 233, 601, 573, 985, 859, 818, 658, 800, 203, 639, 105, 695, 288, 29, 521, 963, 1036, 827, 731, 1013, 713, 682, 924, 609, 284, 848, 6, 534, 784, 1076, 282, 482, 942, 564, 1020, 732, 300, 728, 460, 77, 113, 549, 470, 721, 940, 207, 441, 188, 857, 828, 464, 440, 937, 218, 742, 163, 27, 792, 855, 85, 515, 905, 318, 948, 643, 198, 750, 579, 612, 290, 2, 778, 930, 374, 160, 1004, 894, 845, 1044, 871, 274, 1054, 1098, 984, 177, 169, 879, 260, 1001, 914, 976, 161, 962, 364, 219, 574, 125, 246, 766, 884, 135, 344, 228, 332, 201, 943, 314, 558, 180, 62, 213, 331, 1050, 688, 932, 411, 486, 398, 785, 372, 769, 964, 741, 498, 478, 982, 1095, 670, 787, 1066, 434, 566, 220, 917, 221, 834, 1091, 304, 493, 556, 986, 165, 71, 145, 359, 790, 759, 657, 433, 413, 1009, 25, 650, 555, 511, 577, 537, 376, 949, 874, 1007, 343, 75, 854, 302, 831, 909, 733, 335, 74, 381, 387, 835, 266, 209, 1060, 978, 826, 578, 510, 183, 656, 560, 977, 825, 1048, 249, 898, 532, 777, 1037, 527, 580, 472, 396, 141, 421, 32, 704, 7, 259, 107, 137, 544, 863, 505, 659, 872, 663, 699, 761, 1087, 571, 677, 84, 357, 366, 726, 868, 796, 931, 841, 832, 753, 455, 970, 916, 911, 591, 939, 208, 328, 739, 507, 1078, 915, 1086, 586, 496, 804, 272, 1061, 53, 957, 710, 26, 469, 1071, 820, 281, 452, 996, 641, 1084, 277, 355, 227, 717, 886, 23, 216, 1023, 156, 575, 80, 1111, 987, 1112, 788, 779, 539, 184, 794, 531, 614, 958, 373, 278, 142, 40, 114, 429, 824, 979, 153, 865, 673, 240, 392, 126, 231, 368, 1077, 585, 809, 164, 747, 503, 707, 896, 936, 280, 48, 888, 248, 1083, 450, 92, 292, 709, 16, 230, 945, 1041, 72, 1069, 69, 309, 497, 461, 269, 642, 746, 668, 191, 956, 802, 360, 685, 378, 572, 439, 599, 526, 224, 15, 58, 148, 1029, 972, 444, 1056, 170, 509, 672, 86, 65, 416, 474, 795, 325, 1108, 307, 202, 567, 654, 1092, 275, 451, 393, 138, 253, 901, 587, 538, 315, 37, 245, 306, 613, 603, 485, 322, 649, 319, 50, 803, 565, 999, 475, 767, 98, 716, 712, 553, 771, 908, 1116, 595, 399, 912, 744, 73, 356, 179, 385, 212, 30, 946, 994, 316, 628, 807, 882, 1102, 111, 229, 152, 588, 491, 891, 589, 530, 980, 386, 524, 906, 186, 1058, 262, 729, 961, 861, 570, 426, 1017, 1030, 653, 676, 714, 866, 652, 950, 287, 602, 173, 998, 467, 1011, 869, 786, 773, 617, 651, 251, 725, 172, 662, 674, 988, 133, 140, 297, 312, 353, 1028, 465, 1038, 561, 103, 698, 604, 12, 346, 782, 162, 625, 380, 551, 445, 737, 178, 981, 619, 31, 623, 254, 8, 425, 295, 382, 678, 822, 1119, 798, 543, 990, 41, 1110, 293, 443, 992, 1065, 542, 264, 1062, 535, 102, 880, 255, 350, 104, 701, 490, 966, 351, 907, 547, 1109, 1026, 1033, 34, 847, 134, 919, 719, 546, 522, 415, 338, 965, 799, 621, 79, 562, 1096, 1057, 308, 388, 5, 1059, 877, 1027, 158, 1105, 1075, 175, 829, 11, 541, 118, 193, 488, 402, 52, 700, 244, 483, 947, 94, 337, 1016, 106, 168, 903, 108, 305, 762, 33, 842, 852, 941, 557, 261, 128, 776, 910, 664, 504, 56, 49, 1101, 644, 745, 830, 285, 875, 414, 349, 665, 330, 596, 598, 437, 735, 876, 91, 878, 1099, 54, 211, 856, 1106, 568, 1088, 1073, 805, 157, 371, 708, 336, 605, 494, 484, 993, 1047, 453, 471, 1018, 569, 1082, 730, 902, 1049, 395, 616, 127, 286, 9, 517, 423, 87, 61, 529, 738, 661, 801, 921, 501, 449, 533, 22, 1097, 182, 765, 67, 853, 418, 951, 973, 90, 806, 317, 384, 991, 686, 850, 13, 60, 181, 758, 89, 696, 697, 594, 406, 36, 545, 635, 954, 927, 920, 812, 408, 358, 3, 783, 1114, 1003, 576, 608, 1055, 768, 1080, 100, 195, 1081, 242, 39, 763, 584, 354, 706, 28, 403, 793, 422, 922, 120, 1089, 864, 813, 1051, 194, 1068, 363, 204, 550, 953, 362, 171, 724, 690, 68, 4, 301, 427, 933, 154, 115, 611, 268, 174, 889, 379, 839, 159, 47, 1120, 683, 751, 540, 1103, 610, 1031, 867, 607, 199, 123, 748, 476, 419, 1046, 214, 345, 431, 117, 298, 93, 893, 519, 477, 82, 811, 559, 492, 409, 883, 462, 321, 271, 715, 480, 959, 520, 70, 640, 348, 597, 862, 59, 217, 265, 279, 780, 620, 968, 144, 1100, 375, 606, 583, 814, 289, 1067, 241, 691, 727, 638, 187, 1085, 1042, 51, 1118, 1012, 155, 632, 760, 935, 1015, 582, 680, 1063, 666, 1025, 1035, 55, 226, 96, 238, 838, 294, 554, 432, 19, 147, 324, 523, 190, 167, 808, 1021, 176, 791, 736, 514, 200, 250, 428, 20, 675, 646, 630, 815, 394, 365, 326, 405, 1079, 43, 377, 960, 1006, 681, 817, 99, 684, 1107, 481, 435, 819, 45, 752, 14, 424, 150, 234, 130, 257, 995, 397, 983, 311, 430, 938, 692, 849, 634, 270, 1022, 755, 781, 495, 151, 702, 1008, 770, 459, 823, 720, 146, 276, 1039, 225, 810, 648, 873, 756, 131, 1, 196, 833, 352, 136, 627, 734, 487, 463, 989, 500, 323, 340, 851, 95, 18, 78, 109, 473, 468, 900, 772, 129, 110, 797, 458, 210, 407, 121, 1000, 296, 645, 971, 369, 757, 1045, 836, 35, 624, 489, 313]

# Make sure we're in the experiment directory.
os.chdir(os.path.dirname(os.path.abspath(__file__)))


def get_run_id(task_id):
    return SHUFFLED_TASK_IDS[task_id - 1]


def process_task(task_id):
    run_id = get_run_id(task_id)
    run_dir = get_run_dir(run_id)
    error = False
    driver_log_file = os.path.join(run_dir, "driver.log")

    if os.path.exists(driver_log_file):
        logging.info(f"The run in {run_dir} has already been started --> skip it")
        return False

    with open(driver_log_file, "w") as driver_log:
        with open(os.path.join(run_dir, "driver.err"), "w") as driver_err:
            logging.info(f"Starting run {run_id} (TASK_ID {task_id}) in {run_dir}")
            try:
                subprocess.check_call(
                    [tools.get_python_executable(), "run"],
                    cwd=run_dir, stdout=driver_log, stderr=driver_err)
            except subprocess.CalledProcessError:
                error = True

    # driver.log always has content for a successful run, so we never delete it.
    if os.path.getsize(driver_err.name) == 0:
        os.remove(driver_err.name)
    else:
        error = True

    return error


def main():
    pool = multiprocessing.Pool(processes=4)
    num_tasks = len(SHUFFLED_TASK_IDS)
    result = pool.map_async(process_task, range(1, num_tasks + 1))
    try:
        # Use "timeout" to fix passing KeyboardInterrupts from children
        # (see https://stackoverflow.com/questions/1408356).
        result.wait(timeout=99999)
    except KeyboardInterrupt:
        logging.warning("Main script interrupted")
        pool.terminate()
    finally:
        pool.close()
        logging.info("Joining pool processes")
        pool.join()

    if any(result.get()):
        sys.exit("Error: At least one run failed.")


if __name__ == "__main__":
    main()
