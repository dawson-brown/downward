#! /usr/bin/env python

import logging
import os
import multiprocessing
import subprocess
import sys

from lab.experiment import get_run_dir
from lab import tools

tools.configure_logging()

SHUFFLED_TASK_IDS = [1077, 491, 345, 127, 369, 680, 149, 216, 581, 40, 465, 584, 250, 716, 863, 368, 883, 660, 442, 983, 685, 574, 895, 41, 910, 88, 551, 157, 260, 1120, 789, 768, 202, 798, 116, 455, 942, 802, 267, 351, 350, 928, 494, 452, 29, 701, 1041, 621, 70, 993, 384, 557, 477, 659, 54, 235, 893, 297, 753, 128, 209, 640, 708, 187, 856, 756, 280, 441, 248, 664, 100, 429, 1076, 112, 690, 412, 718, 64, 715, 606, 544, 275, 238, 514, 862, 888, 815, 656, 387, 1065, 812, 439, 1001, 597, 182, 808, 101, 134, 37, 595, 166, 580, 872, 925, 663, 310, 918, 409, 331, 210, 549, 76, 332, 1110, 515, 417, 74, 87, 616, 583, 340, 726, 95, 594, 992, 239, 985, 537, 520, 137, 462, 155, 315, 1124, 911, 1049, 317, 75, 943, 444, 199, 373, 490, 821, 430, 121, 973, 65, 129, 34, 89, 828, 997, 167, 760, 842, 717, 261, 1102, 700, 305, 602, 393, 1045, 253, 3, 1042, 538, 432, 1039, 525, 284, 1008, 864, 758, 436, 975, 431, 915, 435, 792, 311, 402, 299, 123, 980, 418, 1069, 884, 1075, 1114, 416, 767, 1009, 903, 45, 850, 598, 851, 1125, 902, 748, 605, 1032, 982, 106, 933, 704, 626, 545, 288, 281, 881, 508, 414, 1, 577, 611, 771, 894, 759, 457, 932, 81, 395, 757, 1073, 678, 341, 236, 255, 1033, 59, 858, 154, 926, 219, 283, 730, 370, 749, 453, 513, 561, 77, 262, 377, 829, 411, 693, 1023, 193, 398, 277, 197, 326, 1070, 388, 1080, 495, 165, 1053, 300, 880, 524, 772, 502, 643, 620, 729, 963, 279, 11, 456, 245, 873, 467, 628, 459, 848, 995, 374, 1123, 46, 346, 1097, 796, 575, 886, 691, 492, 755, 357, 860, 93, 500, 446, 1121, 53, 25, 287, 969, 882, 329, 825, 1122, 642, 636, 1095, 111, 947, 247, 931, 630, 229, 832, 97, 481, 847, 1046, 961, 383, 1044, 849, 358, 1059, 9, 775, 325, 473, 946, 401, 426, 553, 734, 493, 39, 778, 777, 1067, 890, 657, 721, 978, 386, 185, 309, 652, 761, 188, 138, 797, 1127, 600, 955, 194, 791, 400, 99, 1002, 347, 887, 779, 379, 892, 164, 169, 214, 114, 523, 801, 913, 62, 1030, 720, 878, 148, 922, 72, 579, 960, 737, 192, 566, 964, 822, 569, 1071, 751, 337, 709, 706, 156, 507, 30, 240, 689, 241, 328, 141, 885, 673, 725, 817, 617, 857, 265, 450, 133, 937, 360, 2, 622, 712, 266, 68, 879, 747, 711, 956, 604, 406, 909, 776, 140, 966, 920, 609, 528, 596, 694, 190, 900, 153, 733, 870, 454, 204, 1035, 586, 207, 762, 234, 131, 1058, 56, 592, 790, 483, 752, 669, 813, 648, 637, 348, 301, 754, 1028, 1007, 1051, 510, 246, 69, 498, 987, 898, 1005, 82, 962, 1089, 1029, 292, 445, 380, 256, 991, 505, 471, 585, 929, 633, 788, 397, 32, 150, 173, 161, 540, 1055, 519, 839, 739, 295, 591, 26, 282, 564, 877, 195, 546, 804, 108, 614, 367, 646, 530, 139, 242, 220, 1074, 976, 252, 570, 654, 352, 1111, 233, 1128, 232, 364, 1094, 908, 536, 764, 619, 504, 18, 996, 950, 175, 784, 316, 780, 366, 738, 73, 573, 304, 787, 539, 924, 823, 645, 613, 1088, 146, 999, 263, 22, 559, 1126, 629, 172, 61, 376, 244, 105, 763, 667, 742, 927, 291, 1017, 362, 371, 419, 565, 177, 1054, 889, 1082, 410, 278, 312, 952, 55, 587, 807, 1101, 948, 16, 710, 970, 276, 420, 1064, 809, 1050, 67, 731, 912, 136, 78, 308, 1104, 855, 448, 174, 688, 6, 159, 567, 147, 83, 443, 1103, 212, 225, 979, 1068, 670, 899, 20, 1037, 679, 746, 644, 853, 799, 843, 434, 86, 415, 869, 794, 624, 866, 181, 1019, 875, 285, 226, 269, 407, 1087, 740, 516, 698, 52, 363, 936, 447, 923, 845, 92, 541, 228, 563, 699, 555, 151, 959, 558, 661, 599, 830, 1117, 302, 834, 57, 1107, 703, 463, 119, 170, 35, 826, 1081, 692, 531, 568, 891, 554, 496, 319, 582, 588, 1106, 394, 816, 120, 96, 846, 1004, 965, 230, 327, 222, 800, 183, 827, 938, 1010, 84, 476, 795, 200, 1118, 43, 203, 107, 298, 550, 750, 876, 1025, 142, 293, 80, 944, 354, 211, 994, 303, 404, 474, 590, 941, 385, 865, 603, 533, 223, 405, 160, 47, 464, 1020, 988, 1043, 782, 833, 896, 353, 635, 271, 974, 736, 392, 466, 719, 497, 104, 934, 1091, 318, 682, 19, 840, 1096, 118, 38, 518, 681, 770, 1024, 433, 440, 1115, 707, 361, 697, 102, 122, 198, 196, 15, 638, 735, 115, 814, 968, 874, 1116, 805, 686, 741, 60, 162, 844, 460, 774, 1066, 36, 1099, 665, 14, 470, 727, 634, 307, 94, 695, 143, 647, 79, 58, 1015, 831, 601, 422, 270, 811, 615, 578, 10, 1093, 63, 1083, 330, 819, 152, 651, 1086, 335, 666, 8, 23, 98, 66, 668, 268, 639, 274, 945, 273, 1078, 91, 612, 475, 33, 897, 339, 618, 674, 793, 421, 486, 534, 90, 28, 289, 186, 517, 562, 984, 527, 803, 625, 509, 1108, 218, 953, 4, 227, 867, 391, 24, 989, 610, 958, 986, 249, 103, 820, 178, 835, 511, 324, 484, 382, 773, 608, 1100, 743, 306, 662, 967, 547, 1052, 589, 5, 977, 501, 135, 1006, 423, 939, 356, 189, 529, 631, 1060, 1090, 532, 191, 31, 171, 658, 158, 521, 110, 786, 859, 632, 342, 560, 217, 1021, 684, 1038, 1013, 1018, 257, 488, 713, 818, 650, 403, 372, 1027, 1057, 526, 954, 732, 1034, 901, 868, 396, 343, 838, 424, 399, 522, 971, 168, 201, 990, 338, 224, 258, 254, 389, 1056, 144, 344, 85, 593, 841, 184, 359, 479, 313, 783, 334, 1022, 365, 1085, 49, 208, 696, 132, 259, 27, 1031, 572, 13, 179, 1047, 469, 724, 215, 231, 824, 998, 408, 917, 905, 1000, 17, 124, 861, 781, 323, 836, 1105, 1119, 677, 919, 449, 145, 237, 653, 972, 117, 425, 294, 810, 1003, 916, 12, 649, 482, 785, 1063, 290, 552, 437, 907, 914, 221, 213, 930, 951, 728, 745, 722, 7, 321, 935, 723, 623, 42, 543, 427, 904, 21, 576, 535, 503, 766, 381, 378, 472, 50, 1098, 1011, 744, 71, 1084, 1072, 375, 458, 571, 512, 871, 126, 542, 683, 272, 480, 506, 51, 1048, 714, 854, 322, 349, 333, 1079, 676, 906, 1092, 949, 206, 1012, 390, 548, 489, 765, 251, 1113, 451, 296, 336, 1036, 940, 641, 499, 320, 461, 428, 485, 438, 675, 48, 355, 1109, 109, 314, 286, 806, 180, 672, 413, 921, 478, 607, 687, 113, 1112, 1026, 671, 556, 487, 852, 702, 44, 705, 176, 627, 1040, 837, 769, 468, 163, 125, 957, 1014, 1062, 1016, 205, 981, 243, 655, 1061, 130, 264]

# Make sure we're in the experiment directory.
os.chdir(os.path.dirname(os.path.abspath(__file__)))


def get_run_id(task_id):
    return SHUFFLED_TASK_IDS[task_id - 1]


def process_task(task_id):
    run_id = get_run_id(task_id)
    run_dir = get_run_dir(run_id)
    error = False
    driver_log_file = os.path.join(run_dir, "driver.log")

    if os.path.exists(driver_log_file):
        logging.info(f"The run in {run_dir} has already been started --> skip it")
        return False

    with open(driver_log_file, "w") as driver_log:
        with open(os.path.join(run_dir, "driver.err"), "w") as driver_err:
            logging.info(f"Starting run {run_id} (TASK_ID {task_id}) in {run_dir}")
            try:
                subprocess.check_call(
                    [tools.get_python_executable(), "run"],
                    cwd=run_dir, stdout=driver_log, stderr=driver_err)
            except subprocess.CalledProcessError:
                error = True

    # driver.log always has content for a successful run, so we never delete it.
    if os.path.getsize(driver_err.name) == 0:
        os.remove(driver_err.name)
    else:
        error = True

    return error


def main():
    pool = multiprocessing.Pool(processes=4)
    num_tasks = len(SHUFFLED_TASK_IDS)
    result = pool.map_async(process_task, range(1, num_tasks + 1))
    try:
        # Use "timeout" to fix passing KeyboardInterrupts from children
        # (see https://stackoverflow.com/questions/1408356).
        result.wait(timeout=99999)
    except KeyboardInterrupt:
        logging.warning("Main script interrupted")
        pool.terminate()
    finally:
        pool.close()
        logging.info("Joining pool processes")
        pool.join()

    if any(result.get()):
        sys.exit("Error: At least one run failed.")


if __name__ == "__main__":
    main()
