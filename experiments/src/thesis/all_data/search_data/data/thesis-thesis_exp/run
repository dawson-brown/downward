#! /usr/bin/env python

import logging
import os
import multiprocessing
import subprocess
import sys

from lab.experiment import get_run_dir
from lab import tools

tools.configure_logging()

SHUFFLED_TASK_IDS = [353, 513, 923, 16, 912, 884, 236, 561, 745, 377, 1107, 1172, 574, 34, 456, 520, 415, 438, 155, 655, 300, 341, 630, 621, 767, 1128, 17, 395, 693, 20, 668, 360, 951, 434, 583, 662, 412, 980, 262, 1016, 682, 1074, 1002, 874, 411, 774, 1057, 724, 913, 200, 576, 81, 646, 961, 534, 278, 738, 346, 637, 698, 1171, 793, 601, 802, 213, 784, 839, 62, 1041, 984, 645, 123, 1120, 1165, 1150, 168, 503, 1030, 1140, 77, 362, 306, 116, 1064, 658, 924, 1104, 376, 287, 981, 942, 177, 334, 890, 878, 166, 1025, 508, 398, 712, 492, 1197, 291, 357, 407, 351, 38, 737, 514, 856, 959, 480, 596, 1154, 124, 921, 284, 732, 1082, 956, 431, 975, 459, 1100, 909, 1127, 780, 198, 512, 289, 970, 998, 91, 493, 467, 1169, 736, 64, 106, 153, 600, 586, 623, 199, 146, 888, 770, 1027, 23, 750, 294, 612, 209, 813, 486, 248, 138, 729, 227, 501, 359, 966, 1166, 387, 458, 266, 946, 470, 932, 1188, 627, 1014, 55, 69, 886, 696, 80, 250, 879, 1051, 220, 1009, 479, 862, 849, 673, 444, 368, 1019, 978, 452, 877, 573, 716, 683, 1145, 31, 769, 56, 288, 730, 691, 787, 120, 864, 1069, 852, 39, 121, 225, 832, 133, 465, 546, 914, 154, 354, 969, 1044, 361, 524, 343, 589, 522, 218, 211, 477, 261, 811, 321, 394, 560, 850, 833, 1015, 558, 866, 178, 1049, 714, 824, 1029, 759, 332, 174, 428, 427, 283, 181, 385, 307, 633, 973, 727, 796, 441, 194, 1159, 1191, 690, 176, 1106, 302, 1176, 842, 667, 231, 73, 356, 335, 132, 602, 669, 214, 75, 416, 800, 834, 735, 295, 551, 828, 791, 118, 506, 1198, 1131, 312, 164, 991, 593, 1020, 148, 1141, 273, 99, 108, 96, 606, 778, 648, 670, 733, 804, 952, 320, 680, 383, 269, 743, 1032, 640, 58, 41, 1115, 542, 1143, 1125, 66, 917, 217, 700, 449, 505, 276, 880, 89, 611, 193, 188, 414, 568, 783, 788, 396, 4, 594, 584, 338, 504, 515, 582, 1148, 537, 404, 703, 461, 719, 644, 238, 245, 893, 466, 613, 319, 1097, 911, 635, 223, 285, 904, 367, 355, 1173, 369, 1112, 2, 378, 1105, 1135, 84, 327, 794, 564, 1096, 358, 413, 677, 478, 599, 922, 860, 1089, 244, 482, 1004, 945, 1091, 172, 54, 1110, 785, 777, 330, 197, 988, 468, 938, 526, 475, 1063, 830, 498, 1094, 1108, 1093, 609, 853, 1164, 795, 553, 180, 44, 191, 772, 65, 315, 585, 903, 1005, 247, 941, 349, 709, 547, 160, 254, 1043, 205, 329, 46, 442, 607, 511, 192, 661, 1031, 836, 754, 916, 1114, 749, 1090, 1099, 734, 603, 838, 67, 274, 473, 53, 391, 263, 927, 629, 1178, 699, 104, 242, 130, 885, 175, 1061, 59, 1092, 71, 1098, 528, 195, 610, 776, 819, 450, 1065, 432, 960, 1189, 967, 1079, 548, 426, 326, 405, 748, 224, 790, 580, 487, 1132, 207, 857, 566, 575, 1003, 1142, 840, 98, 704, 152, 752, 639, 489, 634, 150, 1011, 979, 185, 579, 616, 545, 1081, 1000, 848, 779, 1155, 1001, 216, 279, 311, 1078, 485, 418, 494, 303, 590, 631, 196, 958, 50, 847, 915, 309, 253, 265, 818, 532, 296, 507, 305, 408, 865, 380, 345, 469, 1129, 721, 409, 94, 162, 105, 474, 173, 1133, 782, 436, 1124, 137, 87, 159, 827, 215, 663, 894, 260, 761, 61, 299, 1060, 964, 375, 843, 1187, 643, 1059, 93, 10, 483, 290, 445, 1084, 544, 615, 7, 963, 771, 664, 488, 1138, 333, 681, 509, 1006, 591, 898, 264, 102, 835, 1055, 252, 169, 364, 457, 768, 844, 187, 660, 871, 429, 1134, 72, 518, 931, 1122, 910, 652, 982, 797, 918, 301, 786, 184, 846, 587, 837, 905, 1192, 170, 569, 136, 715, 1193, 419, 1042, 165, 1076, 386, 74, 1168, 280, 675, 347, 907, 151, 1117, 1126, 1071, 9, 753, 21, 642, 983, 1121, 695, 746, 1056, 1024, 202, 1068, 976, 112, 651, 219, 298, 773, 297, 324, 316, 685, 1123, 617, 318, 556, 206, 392, 372, 203, 451, 1095, 149, 403, 555, 126, 1077, 1157, 989, 189, 373, 622, 384, 758, 525, 229, 705, 6, 530, 117, 125, 201, 70, 1102, 1180, 241, 1167, 171, 881, 549, 472, 944, 937, 851, 1195, 805, 147, 30, 647, 52, 86, 578, 666, 462, 867, 258, 708, 437, 379, 901, 246, 371, 974, 430, 29, 19, 448, 672, 140, 812, 45, 841, 697, 527, 85, 60, 88, 996, 42, 707, 421, 1101, 930, 1035, 994, 447, 5, 109, 535, 1034, 15, 999, 539, 925, 825, 702, 36, 766, 992, 869, 557, 26, 500, 751, 605, 158, 950, 1113, 420, 491, 1008, 954, 823, 1156, 1153, 1160, 986, 701, 83, 3, 1103, 107, 374, 882, 292, 659, 208, 275, 393, 620, 235, 718, 531, 859, 929, 134, 499, 1183, 24, 139, 270, 439, 632, 654, 870, 382, 1149, 710, 723, 78, 826, 650, 464, 742, 186, 739, 997, 255, 720, 1152, 101, 636, 156, 679, 27, 397, 1170, 581, 692, 110, 363, 798, 22, 400, 928, 82, 1037, 446, 689, 543, 496, 32, 806, 618, 1139, 965, 562, 402, 1179, 122, 939, 1050, 47, 949, 588, 638, 1038, 536, 552, 756, 348, 789, 781, 1109, 281, 906, 453, 570, 455, 476, 1058, 887, 563, 144, 28, 829, 953, 747, 204, 962, 1175, 935, 222, 717, 684, 322, 809, 908, 37, 425, 1118, 1046, 103, 497, 519, 268, 920, 95, 934, 896, 51, 559, 936, 145, 529, 293, 740, 230, 314, 875, 8, 76, 711, 550, 443, 678, 1196, 572, 619, 1054, 567, 1070, 57, 1162, 854, 35, 510, 422, 1026, 592, 328, 731, 1086, 760, 725, 317, 440, 688, 995, 764, 765, 331, 815, 872, 990, 249, 817, 665, 49, 365, 516, 900, 12, 142, 1067, 337, 1073, 985, 282, 876, 902, 1137, 799, 1085, 352, 342, 129, 919, 131, 33, 389, 897, 48, 251, 1181, 1182, 1087, 424, 1, 816, 1185, 1010, 401, 310, 624, 889, 926, 127, 1017, 899, 687, 755, 381, 671, 243, 706, 762, 18, 390, 891, 657, 641, 1111, 1158, 339, 135, 523, 713, 538, 406, 868, 1052, 993, 167, 271, 656, 933, 728, 463, 40, 114, 212, 987, 119, 873, 686, 1013, 649, 820, 814, 845, 803, 232, 614, 571, 1045, 1039, 490, 272, 1036, 628, 435, 1190, 68, 417, 233, 92, 533, 1033, 1075, 90, 115, 210, 957, 653, 410, 221, 540, 831, 183, 141, 240, 1174, 1048, 481, 228, 821, 143, 1062, 11, 608, 190, 111, 971, 1146, 1021, 955, 267, 13, 807, 741, 943, 454, 460, 423, 399, 1040, 763, 892, 277, 63, 726, 565, 163, 1194, 226, 1066, 1130, 366, 256, 308, 1116, 43, 744, 237, 259, 340, 304, 1083, 676, 861, 694, 1119, 1184, 14, 625, 808, 100, 1151, 895, 554, 161, 577, 502, 521, 113, 822, 1199, 810, 597, 1007, 234, 323, 858, 1047, 1072, 598, 595, 1023, 855, 541, 604, 517, 1147, 883, 757, 1080, 801, 940, 257, 775, 1136, 495, 388, 286, 977, 1053, 1088, 157, 968, 325, 79, 1022, 947, 179, 722, 1163, 1028, 1200, 1012, 433, 128, 484, 25, 370, 674, 350, 471, 239, 863, 344, 182, 972, 1144, 1018, 626, 97, 792, 1161, 313, 1177, 948, 336, 1186]

# Make sure we're in the experiment directory.
os.chdir(os.path.dirname(os.path.abspath(__file__)))


def get_run_id(task_id):
    return SHUFFLED_TASK_IDS[task_id - 1]


def process_task(task_id):
    run_id = get_run_id(task_id)
    run_dir = get_run_dir(run_id)
    error = False
    driver_log_file = os.path.join(run_dir, "driver.log")

    if os.path.exists(driver_log_file):
        logging.info(f"The run in {run_dir} has already been started --> skip it")
        return False

    with open(driver_log_file, "w") as driver_log:
        with open(os.path.join(run_dir, "driver.err"), "w") as driver_err:
            logging.info(f"Starting run {run_id} (TASK_ID {task_id}) in {run_dir}")
            try:
                subprocess.check_call(
                    [tools.get_python_executable(), "run"],
                    cwd=run_dir, stdout=driver_log, stderr=driver_err)
            except subprocess.CalledProcessError:
                error = True

    # driver.log always has content for a successful run, so we never delete it.
    if os.path.getsize(driver_err.name) == 0:
        os.remove(driver_err.name)
    else:
        error = True

    return error


def main():
    pool = multiprocessing.Pool(processes=4)
    num_tasks = len(SHUFFLED_TASK_IDS)
    result = pool.map_async(process_task, range(1, num_tasks + 1))
    try:
        # Use "timeout" to fix passing KeyboardInterrupts from children
        # (see https://stackoverflow.com/questions/1408356).
        result.wait(timeout=99999)
    except KeyboardInterrupt:
        logging.warning("Main script interrupted")
        pool.terminate()
    finally:
        pool.close()
        logging.info("Joining pool processes")
        pool.join()

    if any(result.get()):
        sys.exit("Error: At least one run failed.")


if __name__ == "__main__":
    main()
